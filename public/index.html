
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LinkShort - URL Shortener</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen">
    <!-- Header -->
    <header class="bg-white shadow-sm border-b border-gray-200">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-3">
                    <div class="bg-indigo-600 rounded-lg p-2">
                        <i class="fas fa-chart-line text-white text-xl"></i>
                    </div>
                    <h1 class="text-2xl font-bold text-gray-900">LinkShort</h1>
                </div>
                <nav class="flex space-x-4">
                    <a href="/" class="px-4 py-2 rounded-lg font-medium bg-indigo-600 text-white">Dashboard</a>
                    <a href="/health" class="px-4 py-2 rounded-lg font-medium text-gray-600 hover:bg-gray-100">Health</a>
                </nav>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Loading State -->
        <div id="loadingState" class="flex items-center justify-center py-20">
            <div class="text-center">
                <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-600 mx-auto"></div>
                <p class="mt-4 text-gray-600">Loading...</p>
            </div>
        </div>

        <!-- Content (hidden initially) -->
        <div id="mainContent" class="space-y-6 hidden">
            <!-- Stats Cards -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="bg-white rounded-xl shadow-sm p-6 border border-gray-200">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-gray-600 font-medium">Total Links</p>
                            <p id="totalLinks" class="text-3xl font-bold text-gray-900 mt-1">0</p>
                        </div>
                        <div class="bg-blue-100 rounded-full p-3">
                            <i class="fas fa-link text-blue-600 text-xl"></i>
                        </div>
                    </div>
                </div>
                <div class="bg-white rounded-xl shadow-sm p-6 border border-gray-200">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-gray-600 font-medium">Total Clicks</p>
                            <p id="totalClicks" class="text-3xl font-bold text-gray-900 mt-1">0</p>
                        </div>
                        <div class="bg-green-100 rounded-full p-3">
                            <i class="fas fa-mouse-pointer text-green-600 text-xl"></i>
                        </div>
                    </div>
                </div>
                <div class="bg-white rounded-xl shadow-sm p-6 border border-gray-200">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-gray-600 font-medium">Avg Clicks/Link</p>
                            <p id="avgClicks" class="text-3xl font-bold text-gray-900 mt-1">0</p>
                        </div>
                        <div class="bg-purple-100 rounded-full p-3">
                            <i class="fas fa-chart-bar text-purple-600 text-xl"></i>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Actions Bar -->
            <div class="bg-white rounded-xl shadow-sm p-4 border border-gray-200">
                <div class="flex flex-col sm:flex-row gap-4 items-center justify-between">
                    <div class="flex-1 w-full sm:w-auto">
                        <div class="relative">
                            <i class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                            <input
                                type="text"
                                id="searchInput"
                                placeholder="Search by code or URL..."
                                class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
                            />
                        </div>
                    </div>
                    <button
                        onclick="toggleAddForm()"
                        class="flex items-center space-x-2 bg-indigo-600 text-white px-6 py-2 rounded-lg hover:bg-indigo-700 transition-colors font-medium shadow-sm"
                    >
                        <i class="fas fa-plus"></i>
                        <span>Add Link</span>
                    </button>
                </div>
            </div>

            <!-- Add Link Form -->
            <div id="addLinkForm" class="bg-white rounded-xl shadow-sm p-6 border border-gray-200 hidden">
                <h3 class="text-lg font-semibold text-gray-900 mb-4">Create New Short Link</h3>
                <form onsubmit="createLink(event)" class="space-y-4">
                    <div id="formError" class="bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg hidden"></div>
                    <div id="formSuccess" class="bg-green-50 border border-green-200 text-green-700 px-4 py-3 rounded-lg hidden"></div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Target URL *</label>
                        <input
                            type="url"
                            id="targetUrl"
                            required
                            placeholder="https://example.com/your-long-url"
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
                        />
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Custom Code (optional)</label>
                        <input
                            type="text"
                            id="customCode"
                            placeholder="mycode (6-8 alphanumeric characters)"
                            pattern="[A-Za-z0-9]{6,8}"
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
                        />
                        <p class="mt-1 text-sm text-gray-500">Leave empty to generate automatically</p>
                    </div>
                    <div class="flex space-x-3">
                        <button
                            type="submit"
                            id="submitBtn"
                            class="flex-1 bg-indigo-600 text-white px-6 py-2 rounded-lg hover:bg-indigo-700 transition-colors font-medium"
                        >
                            Create Link
                        </button>
                        <button
                            type="button"
                            onclick="toggleAddForm()"
                            class="px-6 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors font-medium text-gray-700"
                        >
                            Cancel
                        </button>
                    </div>
                </form>
            </div>

            <!-- Links Table -->
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead class="bg-gray-50 border-b border-gray-200">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">Short Code</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">Target URL</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">Clicks</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">Last Clicked</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="linksTableBody" class="divide-y divide-gray-200">
                            <!-- Links will be inserted here -->
                        </tbody>
                    </table>
                </div>
                <div id="emptyState" class="text-center py-12 hidden">
                    <p class="text-gray-500">No links found</p>
                </div>
            </div>
        </div>
    </main>

    <script>
        let allLinks = [];

        // Load links on page load
        document.addEventListener('DOMContentLoaded', () => {
            fetchLinks();
            
            // Search functionality
            document.getElementById('searchInput').addEventListener('input', (e) => {
                filterLinks(e.target.value);
            });
        });

        // Fetch all links
        async function fetchLinks() {
            try {
                const response = await fetch('http://localhost:3000/api/links');
                allLinks = await response.json();
                updateStats(allLinks);
                renderLinks(allLinks);
                
                document.getElementById('loadingState').classList.add('hidden');
                document.getElementById('mainContent').classList.remove('hidden');
            } catch (error) {
                console.error('Error fetching links:', error);
                document.getElementById('loadingState').innerHTML = '<p class="text-red-600">Failed to load links</p>';
            }
        }

        // Update statistics
        function updateStats(links) {
            const totalLinks = links.length;
            const totalClicks = links.reduce((sum, link) => sum + link.clicks, 0);
            const avgClicks = totalLinks > 0 ? Math.round(totalClicks / totalLinks) : 0;

            document.getElementById('totalLinks').textContent = totalLinks;
            document.getElementById('totalClicks').textContent = totalClicks;
            document.getElementById('avgClicks').textContent = avgClicks;
        }

        // Render links table
        function renderLinks(links) {
            const tbody = document.getElementById('linksTableBody');
            const emptyState = document.getElementById('emptyState');

            if (links.length === 0) {
                tbody.innerHTML = '';
                emptyState.classList.remove('hidden');
                return;
            }

            emptyState.classList.add('hidden');
            tbody.innerHTML = links.map(link => `
                <tr class="hover:bg-gray-50 transition-colors">
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="flex items-center space-x-2">
                            <code class="text-sm font-mono bg-indigo-50 text-indigo-700 px-2 py-1 rounded">${link.code}</code>
                            <button onclick="copyToClipboard('${window.location.origin}/${link.code}')" class="text-gray-400 hover:text-gray-600" title="Copy short URL">
                                <i class="fas fa-copy"></i>
                            </button>
                        </div>
                    </td>
                    <td class="px-6 py-4">
                        <div class="flex items-center space-x-2 max-w-md">
                            <span class="text-sm text-gray-600 truncate">${link.targetUrl}</span>
                            <a href="${link.targetUrl}" target="_blank" rel="noopener noreferrer" class="text-gray-400 hover:text-gray-600 flex-shrink-0">
                                <i class="fas fa-external-link-alt"></i>
                            </a>
                        </div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="text-sm font-medium text-gray-900">${link.clicks}</span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="text-sm text-gray-600">${formatDate(link.lastClicked)}</span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="flex space-x-2">
                            <a href="/code/${link.code}" class="text-indigo-600 hover:text-indigo-800 font-medium text-sm">Stats</a>
                            <button onclick="deleteLink('${link.code}')" class="text-red-600 hover:text-red-800">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        // Filter links
        function filterLinks(query) {
            const filtered = allLinks.filter(link =>
                link.code.toLowerCase().includes(query.toLowerCase()) ||
                link.targetUrl.toLowerCase().includes(query.toLowerCase())
            );
            renderLinks(filtered);
        }

        // Toggle add form
        function toggleAddForm() {
            const form = document.getElementById('addLinkForm');
            form.classList.toggle('hidden');
            
            // Reset form
            if (!form.classList.contains('hidden')) {
                document.getElementById('targetUrl').value = '';
                document.getElementById('customCode').value = '';
                document.getElementById('formError').classList.add('hidden');
                document.getElementById('formSuccess').classList.add('hidden');
            }
        }

        // Create new link
        async function createLink(event) {
            event.preventDefault();
            
            const submitBtn = document.getElementById('submitBtn');
            const formError = document.getElementById('formError');
            const formSuccess = document.getElementById('formSuccess');
            
            submitBtn.disabled = true;
            submitBtn.textContent = 'Creating...';
            formError.classList.add('hidden');
            formSuccess.classList.add('hidden');

            try {
                const targetUrl = document.getElementById('targetUrl').value;
                const customCode = document.getElementById('customCode').value;

                const response = await fetch('http://localhost:3000/api/links', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ targetUrl, customCode })
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'Failed to create link');
                }

                formSuccess.textContent = `Link created successfully! Short URL: ${data.shortUrl}`;
                formSuccess.classList.remove('hidden');
                
                // Reset form
                document.getElementById('targetUrl').value = '';
                document.getElementById('customCode').value = '';
                
                // Refresh links
                setTimeout(() => {
                    toggleAddForm();
                    fetchLinks();
                }, 2000);

            } catch (error) {
                formError.textContent = error.message;
                formError.classList.remove('hidden');
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Create Link';
            }
        }

        // Delete link
        async function deleteLink(code) {
            if (!confirm('Are you sure you want to delete this link?')) return;

            try {
                const response = await fetch(`/api/links/${code}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    fetchLinks();
                } else {
                    alert('Failed to delete link');
                }
            } catch (error) {
                console.error('Error deleting link:', error);
                alert('Error deleting link');
            }
        }

        // Copy to clipboard
        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                // Visual feedback
                const btn = event.target.closest('button');
                const originalHTML = btn.innerHTML;
                btn.innerHTML = '<i class="fas fa-check text-green-600"></i>';
                setTimeout(() => {
                    btn.innerHTML = originalHTML;
                }, 2000);
            });
        }

        // Format date
        function formatDate(dateStr) {
            if (!dateStr) return 'Never';
            const date = new Date(dateStr);
            return date.toLocaleDateString('en-US', {
                month: 'short',
                day: 'numeric',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }
    </script>
</body>
</html>